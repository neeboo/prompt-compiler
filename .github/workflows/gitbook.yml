name: Deploy Documentation to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/gitbook.yml'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build documentation with Docsify
      run: |
        # 安装 docsify-cli，一个现代化的文档工具
        npm install -g docsify-cli
        
        # 创建 docsify 配置
        cd docs
        
        # 创建 index.html 文件
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>Prompt Compiler Documentation</title>
          <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
          <meta name="description" content="A state-of-the-art AI prompt compiler based on ICL weight update dynamics">
          <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
          <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
        </head>
        <body>
          <div id="app"></div>
          <script>
            window.$docsify = {
              name: 'Prompt Compiler',
              repo: 'https://github.com/neeboo/prompt-compiler',
              loadSidebar: true,
              subMaxLevel: 2,
              search: 'auto',
              copyCode: {
                buttonText : 'Copy to clipboard',
                errorText  : 'Error',
                successText: 'Copied'
              }
            }
          </script>
          <!-- Docsify v4 -->
          <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
          <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
          <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
          <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-rust.min.js"></script>
          <script src="//cdn.jsdelivr.net/npm/docsify-copy-code@2"></script>
        </body>
        </html>
        EOF
        
        # 创建 _sidebar.md 文件（基于 SUMMARY.md）
        cat > _sidebar.md << 'EOF'
        * [Home](/)
        * [Configuration Guide](configuration.md)
        * **Use Cases & Integration**
          * [Real-World Integration Guide](use_cases/real_world_integration_guide.md)
          * [Multi-Agent Context Sharing](use_cases/multi_agent_sharing.md)
        * **Language Versions**
          * [实际集成指南](use_cases/real_world_integration_guide.cn.md)
          * [多Agent上下文共享](use_cases/multi_agent_sharing.cn.md)
        * [Performance Benchmarks](../benches/README.md)
        * [Examples](../examples/README.md)
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
